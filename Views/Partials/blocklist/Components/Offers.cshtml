@using Umbraco.Cms.Core.Models.Blocks
@using Umbraco.Cms.Core.Models
@using Umbraco.Cms.Core.Models.PublishedContent
@using System.Linq
@using Umbraco.Extensions
@inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage<BlockListItem>

@{
    var content = Model.Content;
    
    // Properties
    var title = content.Value<string>("title") ?? content.Value<string>("pageTitle") ?? content.Value<string>("titulo");
    var subtitle = content.Value<string>("subtitle") ?? content.Value<string>("subTitle") ?? content.Value<string>("subtitulo");
    var titlePosition = content.Value<string>("titlePosition") ?? "top";
    
    var description = content.Value<Umbraco.Cms.Core.Strings.IHtmlEncodedString>("description") 
                    ?? content.Value<Umbraco.Cms.Core.Strings.IHtmlEncodedString>("intro")
                    ?? content.Value<Umbraco.Cms.Core.Strings.IHtmlEncodedString>("richText");

    // Block List (Reverted from Block Grid)
    var heroContent = content.Value<BlockListModel>("contentGrid") ?? content.Value<BlockListModel>("heroContent");

    // Subtitle Styles from Template Inspection (30px, Exo font, etc)
    var subtitleStyle = "font-size: 30px; line-height: 1.17; font-weight: 400; color: #fff; text-align: center; margin-bottom: 20px; font-family: 'Exo', sans-serif;";

    var backgroundImage = content.Value<Umbraco.Cms.Core.Models.PublishedContent.IPublishedContent>("backgroundImage");
    var hasBgImage = backgroundImage != null;

    var hasTitle = !string.IsNullOrWhiteSpace(title);
    var hasSubtitle = !string.IsNullOrWhiteSpace(subtitle);
    
    // Strip HTML tags and entities to see if there's real text in the description
    var cleanDescription = description != null ? System.Text.RegularExpressions.Regex.Replace(description.ToString(), "<.*?>", "").Replace("&nbsp;", " ").Trim() : "";
    var hasDescription = !string.IsNullOrWhiteSpace(cleanDescription);
    
    var hasCards = heroContent != null && heroContent.Any();
    
    // RULE: To show the section, we need at least one of these: Subtitle, Description, Cards, or a Background Image.
    var hasContent = hasSubtitle || hasDescription || hasCards || hasBgImage;
}

@if (hasContent)
{
    var isLeft = !string.IsNullOrEmpty(titlePosition) && titlePosition.Equals("left", StringComparison.OrdinalIgnoreCase);
    
    // If it has a background image, we use the "Landing/Hero" style. 
    // Otherwise, we use the "Orange Section" style.
    // If it has a background image, we use the "Landing/Hero" style. 
    // Otherwise, we use the "Orange Section" style.
    // FIX: If isLeft, we MUST include 'ofertas_destacadas' for the title styles to apply, even if it has a bg image.
    string sectionClass;
    if (hasBgImage) {
        sectionClass = isLeft ? "bg-heading-tarifas ofertas_destacadas" : "bg-heading-tarifas";
    } else {
        sectionClass = "ofertas_destacadas bg-deco-ofertas";
    }

    var sectionStyle = hasBgImage 
        ? $"margin-bottom: 0 !important; padding: 50px 0 !important; background-image: url('{backgroundImage.Url()}'); background-size: cover; background-position: center;" 
        : "margin-bottom: 0 !important; padding: 50px 0 !important;";

    <div class="hs_cos_wrapper hs_cos_wrapper_widget hs_cos_wrapper_type_module">
        <section class="@sectionClass" style="@sectionStyle">
            <div class="wrapper">
                <div class="@(isLeft ? "flex-layout-left" : "")" style="@(isLeft ? "display: flex; align-items: center; gap: 40px;" : "")">
                    
                    @if (hasTitle)
                    {
                        if (isLeft)
                        {
                            // LEFT (ANY): Div > p (User Requirement: "When title is left... it is not an h1")
                            <div class="title" style="text-align: left; position: relative;">
                                <p style="margin: 0; padding: 0; text-align: left;">@Html.Raw(title)</p>
                            </div>
                        }
                        else if (hasBgImage)
                        {
                            // HERO / BG IMAGE: H1 (Regardless of position, usually H1 for Hero)
                            <div class="title-container" style="@(isLeft ? "flex: 0 0 350px; text-align: left;" : "text-align: center; margin-bottom: 30px;")">
                                <h1 class="title-tarifas" style="margin-bottom: 0;">@Html.Raw(title)</h1>
                            </div>
                        }
                        else
                        {
                             // CENTERED STANDARD: Div > p (Default fallback)
                            <div class="title-container" style="text-align: center; margin-bottom: 30px;">
                                <div class="title" style="margin-bottom: 0;">
                                    <p>@Html.Raw(title)</p>
                                </div>
                            </div>
                        }
                    }

                    <div style="flex: 1;">
                        @if (hasSubtitle)
                        {
                            <h2 class="subtitle-tarifas" style="@subtitleStyle @(isLeft ? "text-align: left;" : "text-align: center;")">@Html.Raw(subtitle)</h2>
                        }

                        @if (hasDescription)
                        {
                            <div class="description-text" style="margin-bottom: 60px; @(isLeft ? "text-align: left;" : "text-align: center;")">
                                @description
                            </div>
                        }

                        @if (hasCards)
                        {
                            // Determine layout mode:
                            // If NO items have an image, we assume a "Grid" layout (like Fibra+Movil).
                            // If ANY item has an image, we handle items individually (Stacking), using "Columns" for images (Fibra) and fallback for others.
                            var anyItemHasImage = heroContent.Any(x => x.Content.Value<Umbraco.Cms.Core.Models.MediaWithCrops>("image") != null);

                            if (!anyItemHasImage)
                            {
                                @* GRID MODE: Use appropriate container based on page type *@
                                <div class="inner-cards" style="@(isLeft ? "" : "overflow-x: auto; scrollbar-width: none; -ms-overflow-style: none;")">

                                    @foreach (var item in heroContent)
                                    {
                                        var itemContent = item.Content;
                                        var pickedOffers = itemContent.Value<IEnumerable<IPublishedContent>>("cards") 
                                                       ?? itemContent.Value<IEnumerable<IPublishedContent>>("offercard")
                                                       ?? Enumerable.Empty<IPublishedContent>();

                                        if (itemContent.ContentType.Alias.Equals("productCard", StringComparison.OrdinalIgnoreCase))
                                        {
                                            if (pickedOffers != null)
                                            {
                                                foreach (var offer in pickedOffers)
                                                {
                                                    var offerElement = offer as IPublishedElement;
                                                    if (offerElement != null)
                                                    {
                                                        @* Default to 'card' (Horizontal), but _OfferCard will override if cardStyle is 'Vertical' *@
                                                        @await Html.PartialAsync("_OfferCard", offerElement, new ViewDataDictionary(ViewData) { { "isLanding", hasBgImage }, { "cardClass", "card" } })
                                                    }
                                                }
                                            }
                                        }
                                        else if (itemContent.ContentType.Alias.Equals("offerCard", StringComparison.OrdinalIgnoreCase))
                                        {
                                             @* Direct offer card *@
                                             @await Html.PartialAsync("_OfferCard", itemContent, new ViewDataDictionary(ViewData) { { "isLanding", hasBgImage }, { "cardClass", "card" } })
                                        }
                                    }
                                </div>
                            }
                            else
                            {
                                @* MIXED / COLUMNS MODE (Fibra / Landing) *@
                                foreach (var item in heroContent)
                                {
                                    var itemContent = item.Content;

                                    if (itemContent.ContentType.Alias.Equals("productCard", StringComparison.OrdinalIgnoreCase))
                                    {
                                        var cardImage = itemContent.Value<MediaWithCrops>("image");
                                        var pickedOffers = itemContent.Value<IEnumerable<IPublishedContent>>("cards") 
                                                       ?? itemContent.Value<IEnumerable<IPublishedContent>>("offercard")
                                                       ?? Enumerable.Empty<IPublishedContent>();
                                        var hasImage = cardImage != null;

                                        if (hasImage)
                                        {
                                            @* Sidebar Layout: Image + Cards *@
                                            <div class="columns" style="display: flex; flex-wrap: wrap; align-items: center; justify-content: center; margin-bottom: 40px; width: 100%;">
                                                <div class="half-column" style="flex: 1; min-width: 300px; padding: 20px; text-align: center;">
                                                    <img src="@cardImage.Url()" style="max-width: 100%; height: auto; border-radius: 10px;" />
                                                </div>
                                                <div class="half-column" style="flex: 1; min-width: 300px; padding: 20px;">
                                                    <div class="inner-cards" style="display: flex; flex-direction: column; gap: 20px;">
                                                        @if (pickedOffers != null)
                                                        {
                                                            foreach (var offer in pickedOffers)
                                                            {
                                                                var offerElement = offer as IPublishedElement;
                                                                if (offerElement != null)
                                                                {
                                                                    @* Sidebar mode expects .card *@
                                                                    @await Html.PartialAsync("_OfferCard", offerElement, new ViewDataDictionary(ViewData) { { "isLanding", hasBgImage }, { "cardClass", "card" } })
                                                                }
                                                            }
                                                        }
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                        else
                                        {
                                            @* Fallback to Grid for this item *@
                                            <div class="inner-white-cards" style="margin-bottom: 40px;">
                                                @if (pickedOffers != null)
                                                {
                                                    foreach (var offer in pickedOffers)
                                                    {
                                                        var offerElement = offer as IPublishedElement;
                                                        if (offerElement != null)
                                                        {
                                                            @await Html.PartialAsync("_OfferCard", offerElement, new ViewDataDictionary(ViewData) { { "isLanding", hasBgImage }, { "cardClass", "white-card" } })
                                                        }
                                                    }
                                                }
                                            </div>
                                        }
                                    }
                                    else if (itemContent.ContentType.Alias.Equals("offerCard", StringComparison.OrdinalIgnoreCase))
                                    {
                                        @* Direct offerCard in Mixed Mode -> Treat as simple white-card grid item *@
                                        <div class="inner-white-cards">
                                            @await Html.PartialAsync("_OfferCard", itemContent, new ViewDataDictionary(ViewData) { { "isLanding", hasBgImage }, { "cardClass", "white-card" } })
                                        </div>
                                    }
                                }
                            }
                        }

                        @* FOOTER GRID *@
                        @{
                            var footerGrid = content.Value<Umbraco.Cms.Core.Models.Blocks.BlockGridModel>("footer");
                        }
                        @if (footerGrid != null && footerGrid.Any())
                        {
                            <style>
                                .offers-footer-grid { margin-top: 50px; width: 100%; color: @(hasBgImage ? "#fff" : "inherit"); }
                                .offers-footer-grid .umb-block-grid__layout-container {
                                    display: grid;
                                    grid-template-columns: repeat(12, 1fr);
                                    gap: 30px;
                                    align-items: center;
                                }
                                .offers-footer-grid .umb-block-grid__layout-item {
                                    grid-column: span var(--umb-block-grid--item-column-span);
                                }
                                .offers-footer-grid .text-group h3, 
                                .offers-footer-grid .text-group .title { 
                                    font-size: 30px; 
                                    line-height: 1.1; 
                                    font-weight: 700; 
                                    margin-bottom: 15px;
                                    font-family: 'Exo', sans-serif;
                                    color: inherit;
                                }
                                .offers-footer-grid .text-group p,
                                .offers-footer-grid .text-group .description { 
                                    font-size: 16px; 
                                    line-height: 1.4; 
                                    color: inherit; 
                                }
                                .offers-footer-grid .text-group strong { font-weight: 700; }
                                .offers-footer-grid .text-group ul { list-style: disc; padding-left: 20px; margin-top: 10px; }
                                .offers-footer-grid .text-group li { margin-bottom: 8px; font-size: 16px; }
                                
                                /* Responsive adjustment */
                                @@media (max-width: 767px) {
                                    .offers-footer-grid .umb-block-grid__layout-container {
                                        grid-template-columns: 1fr;
                                    }
                                    .offers-footer-grid .umb-block-grid__layout-item {
                                        grid-column: span 1 !important;
                                        text-align: center;
                                    }
                                    .offers-footer-grid .text-group p,
                                    .offers-footer-grid .text-group h3 {
                                        font-size: 24px;
                                    }
                                }
                            </style>
                            <div class="offers-footer-grid">
                                @await Html.GetBlockGridHtmlAsync(footerGrid)
                            </div>
                        }
                    </div>
                </div>
            </div>
        </section>
    </div>
}
