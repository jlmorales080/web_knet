@using System.Linq
@inherits UmbracoViewPage<IPublishedElement>

@{
    var card = Model;
    
    // Properties fallbacks
    var rawPrice = card.Value<string>("price") ?? card.Value<string>("precio");
    var priceDecimal = card.Value<string>("priceDecimal") ?? card.Value<string>("decimales");
    var period = card.Value<string>("period") ?? card.Value<string>("periodo") ?? "IVA incluido"; // Default to IVA incluido
    
    // Automatic Price Splitting Logic
    // If we have a price but no explicit decimal part, try to split it
    var displayedPrice = rawPrice;
    
    if (!string.IsNullOrEmpty(rawPrice) && string.IsNullOrEmpty(priceDecimal))
    {
        // Remove currency symbol for parsing if present
        var cleanPrice = rawPrice.Replace("€", "").Trim();
        
        // Find separator
        char? separator = null;
        if (cleanPrice.Contains(',')) separator = ',';
        else if (cleanPrice.Contains('.')) separator = '.';
        
        if (separator.HasValue)
        {
            var parts = cleanPrice.Split(separator.Value);
            if (parts.Length >= 2)
            {
                displayedPrice = parts[0];
                // Keep only the numeric part, we'll add ' and € in the HTML for consistency
                priceDecimal = parts[1];
            }
        }
    }
    
    var oldPrice = card.Value<string>("oldPrice") ?? card.Value<string>("precioAnterior");
    var cardTitle = card.Value<string>("title") ?? card.Value<string>("cardTitle") ?? card.Value<string>("titulo");
    
    var features = card.Value<Umbraco.Cms.Core.Strings.IHtmlEncodedString>("features") 
                ?? card.Value<Umbraco.Cms.Core.Strings.IHtmlEncodedString>("cardFeatures") 
                ?? card.Value<Umbraco.Cms.Core.Strings.IHtmlEncodedString>("caracteristicas");
    
    // CTA Link - Block List containing navigationIconLink items
    Umbraco.Cms.Core.Models.Link ctaLink = null;
    string ctaIcon = null;
    
    // Get the Block List - property is called 'ctaLink'
    var ctaBlockList = card.Value<Umbraco.Cms.Core.Models.Blocks.BlockListModel>("ctaLink");
    
    if (ctaBlockList != null && ctaBlockList.Any())
    {
        var firstBlock = ctaBlockList.FirstOrDefault();
        
        if (firstBlock?.Content != null)
        {
            var content = firstBlock.Content;
            
            // Try getting 'link' property raw value
            // Try to get the link
            var linkData = content.Value<IEnumerable<Umbraco.Cms.Core.Models.Link>>("link")?.FirstOrDefault(); 
            
            if (linkData == null) 
            {
                 // Try getting as single item
                 var singleLink = content.Value<Umbraco.Cms.Core.Models.Link>("link");
                 if (singleLink != null) linkData = singleLink;
            }

            if (linkData != null)
            {
                ctaLink = linkData;
                
                // Try to get icon as Media Picker
                var iconMedia = content.Value<IPublishedContent>("icon");
                if (iconMedia != null)
                {
                    ctaIcon = iconMedia.Url();
                }
                else
                {
                    // Fallback: try as string (direct URL)
                    ctaIcon = content.Value<string>("icon");
                }
            }
        }
    }
    
    var isLanding = ViewData["isLanding"] as bool? ?? true;
    
    // Determine layout based on 'cardStyle' property from ProductCard (passed via ViewData)
    // Options: "Vertical" (Icon top, stacked) vs "Horizontal" (Title/Price grouped, no top icon) -> Default
    var cardStyleValue = ViewData["cardStyle"] as string ?? card.Value<string>("cardStyle"); // Fallback to card property if not in ViewData
    var isVertical = string.Equals(cardStyleValue, "Vertical", StringComparison.OrdinalIgnoreCase);

    // Padding fixed to 20x40x20x20 as per template inspection
    var styleAttr = "color: #000;";
    // Determine CSS class based strictly on the Style:
    // Vertical -> 'white-card'
    // Horizontal/Default -> 'card'
    // We ignore ViewData["cardClass"] to prevent mismatches (e.g., Offers.cshtml passing 'white-card' but us rendering Horizontal HTML).
    var cardClass = isVertical ? "white-card" : "card";
    
    // For Vertical layout (white-card), the template expects specific internal styling
    if (isVertical) 
    {
         // Ensure it matches the template's 'white-card' structure exactly if needed
    }
}

@* Removed height: 100% to allow parent's align-items: stretch to work. Added align-self: stretch. *@
<div class="@cardClass" style="@styleAttr display: flex; flex-direction: column; flex-shrink: 0; align-self: stretch; height: auto !important;">
    @if (isVertical)
    {
        @* === VERTICAL LAYOUT (white-card / tarifa-movil.html) === *@
        
        @* 1. Top Icon/Image *@
        var image = card.Value<Umbraco.Cms.Core.Models.MediaWithCrops>("image");
        if (image != null)
        {
             <img src="@image.Url()" alt="@(image.Value<string>("alt") ?? "Icono tarifa")" loading="lazy" width="100" height="100" style="max-width: 100%; height: auto;">
        }

        @* 2. Title *@
        <div class="hs_cos_wrapper hs_cos_wrapper_widget hs_cos_wrapper_type_inline_rich_text">
            <h3 class="title">@Html.Raw(cardTitle?.ToUpper())</h3>
        </div>

        @* 3. Subtitle/Tarifa (optional field) *@
        var subtitle = card.Value<string>("subtitle") ?? card.Value<string>("tarifa");
        if (!string.IsNullOrEmpty(subtitle))
        {
            <div class="hs_cos_wrapper hs_cos_wrapper_widget hs_cos_wrapper_type_inline_rich_text">
                <p class="tarifa">@Html.Raw(subtitle)</p>
            </div>
        }

        @* 4. Price Block *@
        <div class="hs_cos_wrapper hs_cos_wrapper_widget hs_cos_wrapper_type_inline_rich_text">
            <div class="group-tarifa">
                <div class="coste">@displayedPrice<br>
                    <div style="display: flex; flex-direction: column; justify-content: space-between;">
                        <sup>'@priceDecimal.Replace("'", "").Replace("€", "").Trim()&nbsp;€</sup> 
                        <sub>@period</sub>
                    </div>
                </div>
                @if (!string.IsNullOrEmpty(oldPrice))
                {
                    <p class="antes">antes @oldPrice</p>
                }
            </div>
        </div>

        @* 4b. Features/Description (Added back below price to match fiber-movil template variant) *@
        if (features != null)
        {
             <div class="hs_cos_wrapper hs_cos_wrapper_widget hs_cos_wrapper_type_inline_rich_text" style="flex-grow: 1; margin-top: 15px; margin-bottom: 25px;"> 
                 @features
             </div>
        }
        else 
        {
            <div style="flex-grow: 1;"></div>
        }

         @* 5. CTA - At bottom *@
        if (ctaLink != null)
        {
            <a href="@ctaLink.Url" class="btn-blue-icon" target="@ctaLink.Target" style="margin-top: auto; align-self: center; display: flex; align-items: center; justify-content: center; gap: 8px;">
                @if (!string.IsNullOrEmpty(ctaIcon))
                {
                    <img src="@ctaIcon" alt="Icon"> 
                }
                @ctaLink.Name
            </a>
        }
    }
    else
    {
        @* === HORIZONTAL LAYOUT (card / Home / Fibra) === *@
        
        <div style="flex: 1;">
            <div class="card-precio">
                <div class="hs_cos_wrapper hs_cos_wrapper_widget hs_cos_wrapper_type_inline_rich_text">
                    <div class="precio">
                        <span style="color: #f05a22;">@displayedPrice</span>
                        <div style="display: flex; flex-direction: column; justify-content: space-between;">
                            <sup style="color: #f05a22;">'@priceDecimal.Replace("'", "").Replace("€", "").Trim()&nbsp;€</sup> 
                            <sub style="color: #f05a22 !important;">@period</sub>
                        </div>
                    </div>
                    @if (!string.IsNullOrEmpty(oldPrice))
                    {
                        <span class="antes">@oldPrice</span>
                    }
                    @if (!string.IsNullOrEmpty(cardTitle))
                    {
                        <p class="tarifa" style="color: #f05a22;">@cardTitle.ToUpper()</p>
                    }
                </div>
            </div>

            @if (features != null)
            {
                <div class="hs_cos_wrapper hs_cos_wrapper_widget hs_cos_wrapper_type_inline_rich_text" style="color: #000 !important;">
                    @features
                </div>
            }
        </div>

        @if (ctaLink != null)
        {
            <div class="hs_cos_wrapper hs_cos_wrapper_widget hs_cos_wrapper_type_inline_rich_text" style="width: 100%; text-align: center;">
                <a href="@ctaLink.Url" class="btn-blue-icon" target="@ctaLink.Target" style="display: inline-flex; align-items: center; justify-content: center; gap: 8px;">
                    @if (!string.IsNullOrEmpty(ctaIcon))
                    {
                        <img src="@ctaIcon" alt="Icon">
                    }
                    @ctaLink.Name
                </a>
            </div>
        }
    }
</div>
